name: Simple Security CI (build + DAST + optional Fortify SAST)

on:
  push:
    branches: ["main"]

permissions:
  contents: read
  actions: read
  security-events: write
  issues: write

jobs:
  test-and-scan:
    runs-on: ubuntu-latest
    env:
      ZAP_REPORT_HTML: zap-report.html
      ZAP_REPORT_JSON: zap-report.json

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Build & Run tests (edit these commands for your project)
        run: |
          # <-- replace the lines below with your project's build/test commands -->
          # Examples (uncomment the one that matches your project):
          # Node.js:
          # npm ci
          # npm test
          #
          # Maven:
          # mvn -B -DskipTests=false test
          #
          # .NET:
          # dotnet restore
          # dotnet test
          #
          echo "Replace this step with your real build/test commands."

      # ---------------------
      # DAST: run ZAP only if TARGET_URL secret exists
      # ---------------------
      - name: Run DAST (OWASP ZAP) if TARGET_URL provided
        if: ${{ secrets.TARGET_URL != '' }}
        run: |
          TARGET=${{ secrets.TARGET_URL }}
          echo "Running ZAP against $TARGET"
          docker pull owasp/zap2docker-stable:latest
          docker run --rm -v $(pwd):/zap/wrk/:rw owasp/zap2docker-stable zap-full-scan.py -t "${TARGET}" -r ${ZAP_REPORT_HTML} -J ${ZAP_REPORT_JSON} || true
          tar -czf zap-reports.tar.gz ${ZAP_REPORT_HTML} ${ZAP_REPORT_JSON} || true

      - name: Upload ZAP reports (if any)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: zap-reports
          path: |
            zap-reports.tar.gz
            ${ZAP_REPORT_HTML}
            ${ZAP_REPORT_JSON}
        continue-on-error: true

      - name: Fail on ZAP Medium+ findings
        if: always() && (secrets.TARGET_URL != '')
        run: |
          if [ ! -f ${ZAP_REPORT_JSON} ]; then
            echo "No ZAP JSON report found, skipping vulnerability fail-check."
            exit 0
          fi
          medium_or_higher=$(jq '[.site[].alerts[]? | select(.riskcode >= 2)] | length' ${ZAP_REPORT_JSON} || echo 0)
          echo "ZAP medium-or-higher alerts count: $medium_or_higher"
          if [ "$medium_or_higher" -gt 0 ]; then
            echo "Found $medium_or_higher medium+ alerts. Failing the job."
            jq '[.site[].alerts[]? | select(.riskcode >= 2) | {name: .name, risk: .risk, url: .url, param: .param}]' ${ZAP_REPORT_JSON} > zap-medium-plus.json || true
            tar -czf zap-medium-plus.tar.gz zap-medium-plus.json || true
            exit 1
          fi

      # ---------------------
      # SAST: Fortify (optional)
      # ---------------------
      - name: Run Fortify SAST (if credentials present)
        if: ${{ secrets.FOD_PAT != '' || secrets.SSC_TOKEN != '' }}
        uses: fortify/github-action@ef5539bf4bd9c45c0bd971978f635a69eae55297
        with:
          sast-scan: true
          debricked-sca-scan: true
        env:
          FOD_URL: https://ams.fortify.com
          FOD_TENANT: ${{ secrets.FOD_TENANT }}
          FOD_USER: ${{ secrets.FOD_USER }}
          FOD_PASSWORD: ${{ secrets.FOD_PAT }}
          SSC_URL: ${{ vars.SSC_URL }}
          SSC_TOKEN: ${{ secrets.SSC_TOKEN }}
          SC_SAST_TOKEN: ${{ secrets.SC_CLIENT_AUTH_TOKEN }}
          DEBRICKED_TOKEN: ${{ secrets.DEBRICKED_TOKEN }}
          DO_WAIT: true
          DO_POLICY_CHECK: true
          DO_JOB_SUMMARY: true
          DO_EXPORT: true
